function K = stiffness (self, assembler, geom, u1, varargin)
% Compute the stiffness matrix by computing and assembling the
% matrices of the individual FEs.
%
% function K = stiffness (self, assembler, geom, u1, u)
%
% Return a stiffness matrix.
%     assembler = descendent of the sysmat_assembler class
%     geom=geometry field
%     u1=displacement field, the current configuration
%     u=displacement field, the last known configuration

% Integration rule
[npts, Ns, gradNparams, w] = integration_data (self);;
gradN =cell(8,1); Jac=cell(8,1);
% Material orientation
Rm_constant = is_material_orientation_constant(self);% if not constant, need to compute  at each point
if (~Rm_constant)
    Rmh = self.Rm;% handle to a function  to evaluate Rm
else
    Rm = self.Rm;
    if (isempty(Rm)),Rm=eye(3);end % for identity transformation
end
% Retrieve data for efficiency
conns = self.fes.conn; % connectivity
labels = self.fes.label; % connectivity
Xs = geom.values; % reference coordinates
context.F = [];
context.stiff_type='Eulerian';
context.ms=[];
% Prepare assembler
Kedim =u1.dim*self.fes.nfens;
start_assembly(assembler, Kedim, Kedim, size(conns,1), u1.nfreedofs, u1.nfreedofs);
for i=1:size(conns,1)
    conn =conns(i,:); % connectivity
    X=Xs(conn,:);
    x1 = X ; % current coordinates
    dofnums =reshape(u1,gather_dofnums(u1,conn));
    Ke =zeros(Kedim);;
    % First we calculate  the mean basis function gradient matrix and the volume of the element
    gradN_mean =zeros(self.fes.nfens,u1.dim); V=0;
    for j=1:npts % loop over all quadrature points
        J = X' * gradNparams{j};% Jacobian matrix wrt reference coordinates
        gradN{j} = gradNparams{j}/J;% derivatives wrt global reference coor
        Jac{j} = det(J);       % if (Jac{j}<=0),error('Non-positive Jacobian');end
        dV=(Jac{j}*w(j));
        gradN_mean =gradN_mean+gradN{j}*dV;
        V =V+dV;
    end
    gradN_mean=gradN_mean/V; % Finish the calculation of the mean basis function gradient matrix
    %     Material orientation?
    if (~Rm_constant)% do I need to evaluate the local material orientation?
        c =mean(X);% physical location of the quadrature point
        if (~isempty(labels )),  Rm =Rmh(c,[],labels(i));%  No Jacobian matrix?
        else,                    Rm =Rmh(c,[],[]);                end
    end
    % Now we calculate the mean deformation gradient    
    Bbar = self.hBlmat(self,[],gradN_mean,[],[]);% strain-displacement d/dX
    D = tangent_moduli (self.material, context);
    D = rotate_stiffness(self.material,D,Rm');
    Ke = (Bbar'*(D*(V))*Bbar);
    context.ms=[]; 
    Dstab = tangent_moduli (self.stabilization_material, context);
    Dstab = rotate_stiffness(self.stabilization_material,Dstab,Rm');
    Ke = Ke - (Bbar'*(Dstab*(self.phis(i)*V))*Bbar);
    for j=1:npts       % Loop over all integration points
        B = self.hBlmat(self,[],gradN{j},[],[]);% strain-displacement
        Dstab = tangent_moduli (self.stabilization_material, context);
        Dstab = rotate_stiffness(self.stabilization_material,Dstab,Rm');
        Ke = Ke + (B'*(Dstab*(self.phis(i)*Jac{j}*w(j)))*B);
    end
    assemble_symmetric(assembler, Ke, dofnums);
end
K = make_matrix (assembler);
end

% function B = adjugate3(A)
%             % A = rand(3)
%             B =[(A(5)*A(9)-A(8)*A(6)),-(A(4)*A(9)-A(7)*A(6)),(A(4)*A(8)-A(7)*A(5));
%             -(A(2)*A(9)-A(8)*A(3)),(A(1)*A(9)-A(7)*A(3)),-(A(1)*A(8)-A(7)*A(2));
%             (A(2)*A(6)-A(5)*A(3)),-(A(1)*A(6)-A(4)*A(3)),(A(1)*A(5)-A(4)*A(2))];
%             % det(A)*inv(A)-B
% end

% function B = adjugate3(A)
% % A = rand(3)
% B =0*A;
% B(1) =(A(5)*A(9)-A(8)*A(6));
% B(2) =-(A(4)*A(9)-A(7)*A(6));
% B(3) =(A(4)*A(8)-A(7)*A(5));
%
% B(4) =-(A(2)*A(9)-A(8)*A(3));
% B(5) =(A(1)*A(9)-A(7)*A(3));
% B(6) =-(A(1)*A(8)-A(7)*A(2));
%
% B(7) =(A(2)*A(6)-A(5)*A(3));
% B(8) =-(A(1)*A(6)-A(4)*A(3));
% B(9) =(A(1)*A(5)-A(4)*A(2));
% % det(A)*inv(A)-B
% end

% function gN=gradN_mean_analytical(X,V)
% gN=[
% [X(2,3)*X(3,2)-X(2,2)*X(3,3)-X(2,2)*X(4,3)+X(2,3)*X(4,2)+X(2,2)*X(5,3)-X(2,3)*X(5,2)-X(3,2)*X(4,3)+X(3,3)*X(4,2)+X(2,2)*X(6,3)-X(2,3)*X(6,2)-X(4,2)*X(5,3)+X(4,3)*X(5,2)-X(5,2)*X(6,3)+X(5,3)*X(6,2)-X(4,2)*X(8,3)+X(4,3)*X(8,2)+X(5,2)*X(8,3)-X(5,3)*X(8,2),   X(2,1)*X(3,3)-X(2,3)*X(3,1)+X(2,1)*X(4,3)-X(2,3)*X(4,1)-X(2,1)*X(5,3)+X(2,3)*X(5,1)+X(3,1)*X(4,3)-X(3,3)*X(4,1)-X(2,1)*X(6,3)+X(2,3)*X(6,1)+X(4,1)*X(5,3)-X(4,3)*X(5,1)+X(5,1)*X(6,3)-X(5,3)*X(6,1)+X(4,1)*X(8,3)-X(4,3)*X(8,1)-X(5,1)*X(8,3)+X(5,3)*X(8,1),   X(2,2)*X(3,1)-X(2,1)*X(3,2)-X(2,1)*X(4,2)+X(2,2)*X(4,1)+X(2,1)*X(5,2)-X(2,2)*X(5,1)-X(3,1)*X(4,2)+X(3,2)*X(4,1)+X(2,1)*X(6,2)-X(2,2)*X(6,1)-X(4,1)*X(5,2)+X(4,2)*X(5,1)-X(5,1)*X(6,2)+X(5,2)*X(6,1)-X(4,1)*X(8,2)+X(4,2)*X(8,1)+X(5,1)*X(8,2)-X(5,2)*X(8,1)]
% [X(1,2)*X(3,3)-X(1,3)*X(3,2)+X(1,2)*X(4,3)-X(1,3)*X(4,2)-X(1,2)*X(5,3)+X(1,3)*X(5,2)-X(1,2)*X(6,3)+X(1,3)*X(6,2)-X(3,2)*X(4,3)+X(3,3)*X(4,2)+X(3,2)*X(6,3)-X(3,3)*X(6,2)+X(3,2)*X(7,3)-X(3,3)*X(7,2)-X(5,2)*X(6,3)+X(5,3)*X(6,2)-X(6,2)*X(7,3)+X(6,3)*X(7,2),   X(1,3)*X(3,1)-X(1,1)*X(3,3)-X(1,1)*X(4,3)+X(1,3)*X(4,1)+X(1,1)*X(5,3)-X(1,3)*X(5,1)+X(1,1)*X(6,3)-X(1,3)*X(6,1)+X(3,1)*X(4,3)-X(3,3)*X(4,1)-X(3,1)*X(6,3)+X(3,3)*X(6,1)-X(3,1)*X(7,3)+X(3,3)*X(7,1)+X(5,1)*X(6,3)-X(5,3)*X(6,1)+X(6,1)*X(7,3)-X(6,3)*X(7,1),   X(1,1)*X(3,2)-X(1,2)*X(3,1)+X(1,1)*X(4,2)-X(1,2)*X(4,1)-X(1,1)*X(5,2)+X(1,2)*X(5,1)-X(1,1)*X(6,2)+X(1,2)*X(6,1)-X(3,1)*X(4,2)+X(3,2)*X(4,1)+X(3,1)*X(6,2)-X(3,2)*X(6,1)+X(3,1)*X(7,2)-X(3,2)*X(7,1)-X(5,1)*X(6,2)+X(5,2)*X(6,1)-X(6,1)*X(7,2)+X(6,2)*X(7,1)]
% [X(1,3)*X(2,2)-X(1,2)*X(2,3)+X(1,2)*X(4,3)-X(1,3)*X(4,2)+X(2,2)*X(4,3)-X(2,3)*X(4,2)-X(2,2)*X(6,3)+X(2,3)*X(6,2)-X(2,2)*X(7,3)+X(2,3)*X(7,2)+X(4,2)*X(7,3)-X(4,3)*X(7,2)+X(4,2)*X(8,3)-X(4,3)*X(8,2)-X(6,2)*X(7,3)+X(6,3)*X(7,2)-X(7,2)*X(8,3)+X(7,3)*X(8,2),   X(1,1)*X(2,3)-X(1,3)*X(2,1)-X(1,1)*X(4,3)+X(1,3)*X(4,1)-X(2,1)*X(4,3)+X(2,3)*X(4,1)+X(2,1)*X(6,3)-X(2,3)*X(6,1)+X(2,1)*X(7,3)-X(2,3)*X(7,1)-X(4,1)*X(7,3)+X(4,3)*X(7,1)-X(4,1)*X(8,3)+X(4,3)*X(8,1)+X(6,1)*X(7,3)-X(6,3)*X(7,1)+X(7,1)*X(8,3)-X(7,3)*X(8,1),   X(1,2)*X(2,1)-X(1,1)*X(2,2)+X(1,1)*X(4,2)-X(1,2)*X(4,1)+X(2,1)*X(4,2)-X(2,2)*X(4,1)-X(2,1)*X(6,2)+X(2,2)*X(6,1)-X(2,1)*X(7,2)+X(2,2)*X(7,1)+X(4,1)*X(7,2)-X(4,2)*X(7,1)+X(4,1)*X(8,2)-X(4,2)*X(8,1)-X(6,1)*X(7,2)+X(6,2)*X(7,1)-X(7,1)*X(8,2)+X(7,2)*X(8,1)]
% [X(1,3)*X(2,2)-X(1,2)*X(2,3)-X(1,2)*X(3,3)+X(1,3)*X(3,2)-X(2,2)*X(3,3)+X(2,3)*X(3,2)+X(1,2)*X(5,3)-X(1,3)*X(5,2)+X(1,2)*X(8,3)-X(1,3)*X(8,2)-X(3,2)*X(7,3)+X(3,3)*X(7,2)-X(3,2)*X(8,3)+X(3,3)*X(8,2)+X(5,2)*X(8,3)-X(5,3)*X(8,2)-X(7,2)*X(8,3)+X(7,3)*X(8,2),   X(1,1)*X(2,3)-X(1,3)*X(2,1)+X(1,1)*X(3,3)-X(1,3)*X(3,1)+X(2,1)*X(3,3)-X(2,3)*X(3,1)-X(1,1)*X(5,3)+X(1,3)*X(5,1)-X(1,1)*X(8,3)+X(1,3)*X(8,1)+X(3,1)*X(7,3)-X(3,3)*X(7,1)+X(3,1)*X(8,3)-X(3,3)*X(8,1)-X(5,1)*X(8,3)+X(5,3)*X(8,1)+X(7,1)*X(8,3)-X(7,3)*X(8,1),   X(1,2)*X(2,1)-X(1,1)*X(2,2)-X(1,1)*X(3,2)+X(1,2)*X(3,1)-X(2,1)*X(3,2)+X(2,2)*X(3,1)+X(1,1)*X(5,2)-X(1,2)*X(5,1)+X(1,1)*X(8,2)-X(1,2)*X(8,1)-X(3,1)*X(7,2)+X(3,2)*X(7,1)-X(3,1)*X(8,2)+X(3,2)*X(8,1)+X(5,1)*X(8,2)-X(5,2)*X(8,1)-X(7,1)*X(8,2)+X(7,2)*X(8,1)]
% [X(1,2)*X(2,3)-X(1,3)*X(2,2)-X(1,2)*X(4,3)+X(1,3)*X(4,2)+X(1,2)*X(6,3)-X(1,3)*X(6,2)+X(2,2)*X(6,3)-X(2,3)*X(6,2)-X(1,2)*X(8,3)+X(1,3)*X(8,2)-X(4,2)*X(8,3)+X(4,3)*X(8,2)+X(6,2)*X(7,3)-X(6,3)*X(7,2)+X(6,2)*X(8,3)-X(6,3)*X(8,2)+X(7,2)*X(8,3)-X(7,3)*X(8,2),   X(1,3)*X(2,1)-X(1,1)*X(2,3)+X(1,1)*X(4,3)-X(1,3)*X(4,1)-X(1,1)*X(6,3)+X(1,3)*X(6,1)-X(2,1)*X(6,3)+X(2,3)*X(6,1)+X(1,1)*X(8,3)-X(1,3)*X(8,1)+X(4,1)*X(8,3)-X(4,3)*X(8,1)-X(6,1)*X(7,3)+X(6,3)*X(7,1)-X(6,1)*X(8,3)+X(6,3)*X(8,1)-X(7,1)*X(8,3)+X(7,3)*X(8,1),   X(1,1)*X(2,2)-X(1,2)*X(2,1)-X(1,1)*X(4,2)+X(1,2)*X(4,1)+X(1,1)*X(6,2)-X(1,2)*X(6,1)+X(2,1)*X(6,2)-X(2,2)*X(6,1)-X(1,1)*X(8,2)+X(1,2)*X(8,1)-X(4,1)*X(8,2)+X(4,2)*X(8,1)+X(6,1)*X(7,2)-X(6,2)*X(7,1)+X(6,1)*X(8,2)-X(6,2)*X(8,1)+X(7,1)*X(8,2)-X(7,2)*X(8,1)]
% [X(1,2)*X(2,3)-X(1,3)*X(2,2)+X(2,2)*X(3,3)-X(2,3)*X(3,2)-X(1,2)*X(5,3)+X(1,3)*X(5,2)-X(2,2)*X(5,3)+X(2,3)*X(5,2)+X(2,2)*X(7,3)-X(2,3)*X(7,2)+X(3,2)*X(7,3)-X(3,3)*X(7,2)-X(5,2)*X(7,3)+X(5,3)*X(7,2)-X(5,2)*X(8,3)+X(5,3)*X(8,2)+X(7,2)*X(8,3)-X(7,3)*X(8,2),   X(1,3)*X(2,1)-X(1,1)*X(2,3)-X(2,1)*X(3,3)+X(2,3)*X(3,1)+X(1,1)*X(5,3)-X(1,3)*X(5,1)+X(2,1)*X(5,3)-X(2,3)*X(5,1)-X(2,1)*X(7,3)+X(2,3)*X(7,1)-X(3,1)*X(7,3)+X(3,3)*X(7,1)+X(5,1)*X(7,3)-X(5,3)*X(7,1)+X(5,1)*X(8,3)-X(5,3)*X(8,1)-X(7,1)*X(8,3)+X(7,3)*X(8,1),   X(1,1)*X(2,2)-X(1,2)*X(2,1)+X(2,1)*X(3,2)-X(2,2)*X(3,1)-X(1,1)*X(5,2)+X(1,2)*X(5,1)-X(2,1)*X(5,2)+X(2,2)*X(5,1)+X(2,1)*X(7,2)-X(2,2)*X(7,1)+X(3,1)*X(7,2)-X(3,2)*X(7,1)-X(5,1)*X(7,2)+X(5,2)*X(7,1)-X(5,1)*X(8,2)+X(5,2)*X(8,1)+X(7,1)*X(8,2)-X(7,2)*X(8,1)]
% [X(2,2)*X(3,3)-X(2,3)*X(3,2)+X(3,2)*X(4,3)-X(3,3)*X(4,2)-X(2,2)*X(6,3)+X(2,3)*X(6,2)-X(3,2)*X(6,3)+X(3,3)*X(6,2)+X(3,2)*X(8,3)-X(3,3)*X(8,2)+X(5,2)*X(6,3)-X(5,3)*X(6,2)+X(4,2)*X(8,3)-X(4,3)*X(8,2)-X(5,2)*X(8,3)+X(5,3)*X(8,2)-X(6,2)*X(8,3)+X(6,3)*X(8,2),   X(2,3)*X(3,1)-X(2,1)*X(3,3)-X(3,1)*X(4,3)+X(3,3)*X(4,1)+X(2,1)*X(6,3)-X(2,3)*X(6,1)+X(3,1)*X(6,3)-X(3,3)*X(6,1)-X(3,1)*X(8,3)+X(3,3)*X(8,1)-X(5,1)*X(6,3)+X(5,3)*X(6,1)-X(4,1)*X(8,3)+X(4,3)*X(8,1)+X(5,1)*X(8,3)-X(5,3)*X(8,1)+X(6,1)*X(8,3)-X(6,3)*X(8,1),   X(2,1)*X(3,2)-X(2,2)*X(3,1)+X(3,1)*X(4,2)-X(3,2)*X(4,1)-X(2,1)*X(6,2)+X(2,2)*X(6,1)-X(3,1)*X(6,2)+X(3,2)*X(6,1)+X(3,1)*X(8,2)-X(3,2)*X(8,1)+X(5,1)*X(6,2)-X(5,2)*X(6,1)+X(4,1)*X(8,2)-X(4,2)*X(8,1)-X(5,1)*X(8,2)+X(5,2)*X(8,1)-X(6,1)*X(8,2)+X(6,2)*X(8,1)]
% [X(1,3)*X(4,2)-X(1,2)*X(4,3)+X(1,2)*X(5,3)-X(1,3)*X(5,2)+X(3,2)*X(4,3)-X(3,3)*X(4,2)+X(4,2)*X(5,3)-X(4,3)*X(5,2)-X(3,2)*X(7,3)+X(3,3)*X(7,2)-X(4,2)*X(7,3)+X(4,3)*X(7,2)+X(5,2)*X(6,3)-X(5,3)*X(6,2)+X(5,2)*X(7,3)-X(5,3)*X(7,2)+X(6,2)*X(7,3)-X(6,3)*X(7,2),   X(1,1)*X(4,3)-X(1,3)*X(4,1)-X(1,1)*X(5,3)+X(1,3)*X(5,1)-X(3,1)*X(4,3)+X(3,3)*X(4,1)-X(4,1)*X(5,3)+X(4,3)*X(5,1)+X(3,1)*X(7,3)-X(3,3)*X(7,1)+X(4,1)*X(7,3)-X(4,3)*X(7,1)-X(5,1)*X(6,3)+X(5,3)*X(6,1)-X(5,1)*X(7,3)+X(5,3)*X(7,1)-X(6,1)*X(7,3)+X(6,3)*X(7,1),   X(1,2)*X(4,1)-X(1,1)*X(4,2)+X(1,1)*X(5,2)-X(1,2)*X(5,1)+X(3,1)*X(4,2)-X(3,2)*X(4,1)+X(4,1)*X(5,2)-X(4,2)*X(5,1)-X(3,1)*X(7,2)+X(3,2)*X(7,1)-X(4,1)*X(7,2)+X(4,2)*X(7,1)+X(5,1)*X(6,2)-X(5,2)*X(6,1)+X(5,1)*X(7,2)-X(5,2)*X(7,1)+X(6,1)*X(7,2)-X(6,2)*X(7,1)]
% ] / V;
% end

% function gN=gradN_mean_analytical(X,V)
% % for i=1:8
% %     for  j=1:3
% %         disp(['X',num2str(i), '_', num2str(j),'=', 'X(',num2str(i), ',', num2str(j),')',';'])
% %     end
% % end
% %
% % X1_1=X(1,1);
% % X1_2=X(1,2);
% % X1_3=X(1,3);
% % X2_1=X(2,1);
% % X2_2=X(2,2);
% % X2_3=X(2,3);
% % X3_1=X(3,1);
% % X3_2=X(3,2);
% % X3_3=X(3,3);
% % X4_1=X(4,1);
% % X4_2=X(4,2);
% % X4_3=X(4,3);
% % X5_1=X(5,1);
% % X5_2=X(5,2);
% % X5_3=X(5,3);
% % X6_1=X(6,1);
% % X6_2=X(6,2);
% % X6_3=X(6,3);
% % X7_1=X(7,1);
% % X7_2=X(7,2);
% % X7_3=X(7,3);
% % X8_1=X(8,1);
% % X8_2=X(8,2);
% % X8_3=X(8,3);
%
% gN=[
% [X(2,3)*X(3,2)-X(2,2)*X(3,3)-X(2,2)*X(4,3)+X(2,3)*X(4,2)+X(2,2)*X(5,3)-X(2,3)*X(5,2)-X(3,2)*X(4,3)+X(3,3)*X(4,2)+X(2,2)*X(6,3)-X(2,3)*X(6,2)-X(4,2)*X(5,3)+X(4,3)*X(5,2)-X(5,2)*X(6,3)+X(5,3)*X(6,2)-X(4,2)*X(8,3)+X(4,3)*X(8,2)+X(5,2)*X(8,3)-X(5,3)*X(8,2),   X(2,1)*X(3,3)-X(2,3)*X(3,1)+X(2,1)*X(4,3)-X(2,3)*X(4,1)-X(2,1)*X(5,3)+X(2,3)*X(5,1)+X(3,1)*X(4,3)-X(3,3)*X(4,1)-X(2,1)*X(6,3)+X(2,3)*X(6,1)+X(4,1)*X(5,3)-X(4,3)*X(5,1)+X(5,1)*X(6,3)-X(5,3)*X(6,1)+X(4,1)*X(8,3)-X(4,3)*X(8,1)-X(5,1)*X(8,3)+X(5,3)*X(8,1),   X(2,2)*X(3,1)-X(2,1)*X(3,2)-X(2,1)*X(4,2)+X(2,2)*X(4,1)+X(2,1)*X(5,2)-X(2,2)*X(5,1)-X(3,1)*X(4,2)+X(3,2)*X(4,1)+X(2,1)*X(6,2)-X(2,2)*X(6,1)-X(4,1)*X(5,2)+X(4,2)*X(5,1)-X(5,1)*X(6,2)+X(5,2)*X(6,1)-X(4,1)*X(8,2)+X(4,2)*X(8,1)+X(5,1)*X(8,2)-X(5,2)*X(8,1)]
% [X(1,2)*X(3,3)-X(1,3)*X(3,2)+X(1,2)*X(4,3)-X(1,3)*X(4,2)-X(1,2)*X(5,3)+X(1,3)*X(5,2)-X(1,2)*X(6,3)+X(1,3)*X(6,2)-X(3,2)*X(4,3)+X(3,3)*X(4,2)+X(3,2)*X(6,3)-X(3,3)*X(6,2)+X(3,2)*X(7,3)-X(3,3)*X(7,2)-X(5,2)*X(6,3)+X(5,3)*X(6,2)-X(6,2)*X(7,3)+X(6,3)*X(7,2),   X(1,3)*X(3,1)-X(1,1)*X(3,3)-X(1,1)*X(4,3)+X(1,3)*X(4,1)+X(1,1)*X(5,3)-X(1,3)*X(5,1)+X(1,1)*X(6,3)-X(1,3)*X(6,1)+X(3,1)*X(4,3)-X(3,3)*X(4,1)-X(3,1)*X(6,3)+X(3,3)*X(6,1)-X(3,1)*X(7,3)+X(3,3)*X(7,1)+X(5,1)*X(6,3)-X(5,3)*X(6,1)+X(6,1)*X(7,3)-X(6,3)*X(7,1),   X(1,1)*X(3,2)-X(1,2)*X(3,1)+X(1,1)*X(4,2)-X(1,2)*X(4,1)-X(1,1)*X(5,2)+X(1,2)*X(5,1)-X(1,1)*X(6,2)+X(1,2)*X(6,1)-X(3,1)*X(4,2)+X(3,2)*X(4,1)+X(3,1)*X(6,2)-X(3,2)*X(6,1)+X(3,1)*X(7,2)-X(3,2)*X(7,1)-X(5,1)*X(6,2)+X(5,2)*X(6,1)-X(6,1)*X(7,2)+X(6,2)*X(7,1)]
% [X(1,3)*X(2,2)-X(1,2)*X(2,3)+X(1,2)*X(4,3)-X(1,3)*X(4,2)+X(2,2)*X(4,3)-X(2,3)*X(4,2)-X(2,2)*X(6,3)+X(2,3)*X(6,2)-X(2,2)*X(7,3)+X(2,3)*X(7,2)+X(4,2)*X(7,3)-X(4,3)*X(7,2)+X(4,2)*X(8,3)-X(4,3)*X(8,2)-X(6,2)*X(7,3)+X(6,3)*X(7,2)-X(7,2)*X(8,3)+X(7,3)*X(8,2),   X(1,1)*X(2,3)-X(1,3)*X(2,1)-X(1,1)*X(4,3)+X(1,3)*X(4,1)-X(2,1)*X(4,3)+X(2,3)*X(4,1)+X(2,1)*X(6,3)-X(2,3)*X(6,1)+X(2,1)*X(7,3)-X(2,3)*X(7,1)-X(4,1)*X(7,3)+X(4,3)*X(7,1)-X(4,1)*X(8,3)+X(4,3)*X(8,1)+X(6,1)*X(7,3)-X(6,3)*X(7,1)+X(7,1)*X(8,3)-X(7,3)*X(8,1),   X(1,2)*X(2,1)-X(1,1)*X(2,2)+X(1,1)*X(4,2)-X(1,2)*X(4,1)+X(2,1)*X(4,2)-X(2,2)*X(4,1)-X(2,1)*X(6,2)+X(2,2)*X(6,1)-X(2,1)*X(7,2)+X(2,2)*X(7,1)+X(4,1)*X(7,2)-X(4,2)*X(7,1)+X(4,1)*X(8,2)-X(4,2)*X(8,1)-X(6,1)*X(7,2)+X(6,2)*X(7,1)-X(7,1)*X(8,2)+X(7,2)*X(8,1)]
% [X(1,3)*X(2,2)-X(1,2)*X(2,3)-X(1,2)*X(3,3)+X(1,3)*X(3,2)-X(2,2)*X(3,3)+X(2,3)*X(3,2)+X(1,2)*X(5,3)-X(1,3)*X(5,2)+X(1,2)*X(8,3)-X(1,3)*X(8,2)-X(3,2)*X(7,3)+X(3,3)*X(7,2)-X(3,2)*X(8,3)+X(3,3)*X(8,2)+X(5,2)*X(8,3)-X(5,3)*X(8,2)-X(7,2)*X(8,3)+X(7,3)*X(8,2),   X(1,1)*X(2,3)-X(1,3)*X(2,1)+X(1,1)*X(3,3)-X(1,3)*X(3,1)+X(2,1)*X(3,3)-X(2,3)*X(3,1)-X(1,1)*X(5,3)+X(1,3)*X(5,1)-X(1,1)*X(8,3)+X(1,3)*X(8,1)+X(3,1)*X(7,3)-X(3,3)*X(7,1)+X(3,1)*X(8,3)-X(3,3)*X(8,1)-X(5,1)*X(8,3)+X(5,3)*X(8,1)+X(7,1)*X(8,3)-X(7,3)*X(8,1),   X(1,2)*X(2,1)-X(1,1)*X(2,2)-X(1,1)*X(3,2)+X(1,2)*X(3,1)-X(2,1)*X(3,2)+X(2,2)*X(3,1)+X(1,1)*X(5,2)-X(1,2)*X(5,1)+X(1,1)*X(8,2)-X(1,2)*X(8,1)-X(3,1)*X(7,2)+X(3,2)*X(7,1)-X(3,1)*X(8,2)+X(3,2)*X(8,1)+X(5,1)*X(8,2)-X(5,2)*X(8,1)-X(7,1)*X(8,2)+X(7,2)*X(8,1)]
% [X(1,2)*X(2,3)-X(1,3)*X(2,2)-X(1,2)*X(4,3)+X(1,3)*X(4,2)+X(1,2)*X(6,3)-X(1,3)*X(6,2)+X(2,2)*X(6,3)-X(2,3)*X(6,2)-X(1,2)*X(8,3)+X(1,3)*X(8,2)-X(4,2)*X(8,3)+X(4,3)*X(8,2)+X(6,2)*X(7,3)-X(6,3)*X(7,2)+X(6,2)*X(8,3)-X(6,3)*X(8,2)+X(7,2)*X(8,3)-X(7,3)*X(8,2),   X(1,3)*X(2,1)-X(1,1)*X(2,3)+X(1,1)*X(4,3)-X(1,3)*X(4,1)-X(1,1)*X(6,3)+X(1,3)*X(6,1)-X(2,1)*X(6,3)+X(2,3)*X(6,1)+X(1,1)*X(8,3)-X(1,3)*X(8,1)+X(4,1)*X(8,3)-X(4,3)*X(8,1)-X(6,1)*X(7,3)+X(6,3)*X(7,1)-X(6,1)*X(8,3)+X(6,3)*X(8,1)-X(7,1)*X(8,3)+X(7,3)*X(8,1),   X(1,1)*X(2,2)-X(1,2)*X(2,1)-X(1,1)*X(4,2)+X(1,2)*X(4,1)+X(1,1)*X(6,2)-X(1,2)*X(6,1)+X(2,1)*X(6,2)-X(2,2)*X(6,1)-X(1,1)*X(8,2)+X(1,2)*X(8,1)-X(4,1)*X(8,2)+X(4,2)*X(8,1)+X(6,1)*X(7,2)-X(6,2)*X(7,1)+X(6,1)*X(8,2)-X(6,2)*X(8,1)+X(7,1)*X(8,2)-X(7,2)*X(8,1)]
% [X(1,2)*X(2,3)-X(1,3)*X(2,2)+X(2,2)*X(3,3)-X(2,3)*X(3,2)-X(1,2)*X(5,3)+X(1,3)*X(5,2)-X(2,2)*X(5,3)+X(2,3)*X(5,2)+X(2,2)*X(7,3)-X(2,3)*X(7,2)+X(3,2)*X(7,3)-X(3,3)*X(7,2)-X(5,2)*X(7,3)+X(5,3)*X(7,2)-X(5,2)*X(8,3)+X(5,3)*X(8,2)+X(7,2)*X(8,3)-X(7,3)*X(8,2),   X(1,3)*X(2,1)-X(1,1)*X(2,3)-X(2,1)*X(3,3)+X(2,3)*X(3,1)+X(1,1)*X(5,3)-X(1,3)*X(5,1)+X(2,1)*X(5,3)-X(2,3)*X(5,1)-X(2,1)*X(7,3)+X(2,3)*X(7,1)-X(3,1)*X(7,3)+X(3,3)*X(7,1)+X(5,1)*X(7,3)-X(5,3)*X(7,1)+X(5,1)*X(8,3)-X(5,3)*X(8,1)-X(7,1)*X(8,3)+X(7,3)*X(8,1),   X(1,1)*X(2,2)-X(1,2)*X(2,1)+X(2,1)*X(3,2)-X(2,2)*X(3,1)-X(1,1)*X(5,2)+X(1,2)*X(5,1)-X(2,1)*X(5,2)+X(2,2)*X(5,1)+X(2,1)*X(7,2)-X(2,2)*X(7,1)+X(3,1)*X(7,2)-X(3,2)*X(7,1)-X(5,1)*X(7,2)+X(5,2)*X(7,1)-X(5,1)*X(8,2)+X(5,2)*X(8,1)+X(7,1)*X(8,2)-X(7,2)*X(8,1)]
% [X(2,2)*X(3,3)-X(2,3)*X(3,2)+X(3,2)*X(4,3)-X(3,3)*X(4,2)-X(2,2)*X(6,3)+X(2,3)*X(6,2)-X(3,2)*X(6,3)+X(3,3)*X(6,2)+X(3,2)*X(8,3)-X(3,3)*X(8,2)+X(5,2)*X(6,3)-X(5,3)*X(6,2)+X(4,2)*X(8,3)-X(4,3)*X(8,2)-X(5,2)*X(8,3)+X(5,3)*X(8,2)-X(6,2)*X(8,3)+X(6,3)*X(8,2),   X(2,3)*X(3,1)-X(2,1)*X(3,3)-X(3,1)*X(4,3)+X(3,3)*X(4,1)+X(2,1)*X(6,3)-X(2,3)*X(6,1)+X(3,1)*X(6,3)-X(3,3)*X(6,1)-X(3,1)*X(8,3)+X(3,3)*X(8,1)-X(5,1)*X(6,3)+X(5,3)*X(6,1)-X(4,1)*X(8,3)+X(4,3)*X(8,1)+X(5,1)*X(8,3)-X(5,3)*X(8,1)+X(6,1)*X(8,3)-X(6,3)*X(8,1),   X(2,1)*X(3,2)-X(2,2)*X(3,1)+X(3,1)*X(4,2)-X(3,2)*X(4,1)-X(2,1)*X(6,2)+X(2,2)*X(6,1)-X(3,1)*X(6,2)+X(3,2)*X(6,1)+X(3,1)*X(8,2)-X(3,2)*X(8,1)+X(5,1)*X(6,2)-X(5,2)*X(6,1)+X(4,1)*X(8,2)-X(4,2)*X(8,1)-X(5,1)*X(8,2)+X(5,2)*X(8,1)-X(6,1)*X(8,2)+X(6,2)*X(8,1)]
% [X(1,3)*X(4,2)-X(1,2)*X(4,3)+X(1,2)*X(5,3)-X(1,3)*X(5,2)+X(3,2)*X(4,3)-X(3,3)*X(4,2)+X(4,2)*X(5,3)-X(4,3)*X(5,2)-X(3,2)*X(7,3)+X(3,3)*X(7,2)-X(4,2)*X(7,3)+X(4,3)*X(7,2)+X(5,2)*X(6,3)-X(5,3)*X(6,2)+X(5,2)*X(7,3)-X(5,3)*X(7,2)+X(6,2)*X(7,3)-X(6,3)*X(7,2),   X(1,1)*X(4,3)-X(1,3)*X(4,1)-X(1,1)*X(5,3)+X(1,3)*X(5,1)-X(3,1)*X(4,3)+X(3,3)*X(4,1)-X(4,1)*X(5,3)+X(4,3)*X(5,1)+X(3,1)*X(7,3)-X(3,3)*X(7,1)+X(4,1)*X(7,3)-X(4,3)*X(7,1)-X(5,1)*X(6,3)+X(5,3)*X(6,1)-X(5,1)*X(7,3)+X(5,3)*X(7,1)-X(6,1)*X(7,3)+X(6,3)*X(7,1),   X(1,2)*X(4,1)-X(1,1)*X(4,2)+X(1,1)*X(5,2)-X(1,2)*X(5,1)+X(3,1)*X(4,2)-X(3,2)*X(4,1)+X(4,1)*X(5,2)-X(4,2)*X(5,1)-X(3,1)*X(7,2)+X(3,2)*X(7,1)-X(4,1)*X(7,2)+X(4,2)*X(7,1)+X(5,1)*X(6,2)-X(5,2)*X(6,1)+X(5,1)*X(7,2)-X(5,2)*X(7,1)+X(6,1)*X(7,2)-X(6,2)*X(7,1)]
% ]/(12*V);
% end

% function V=V_analytically(X)
% V=X(1,1)*X(2,3)*X(3,2)-X(1,1)*X(2,2)*X(3,3)+X(1,2)*X(2,1)*X(3,3)-X(1,2)*X(2,3)*X(3,1)-X(1,3)*X(2,1)*X(3,2) ...
%     +X(1,3)*X(2,2)*X(3,1)-X(1,1)*X(2,2)*X(4,3)+X(1,1)*X(2,3)*X(4,2)+X(1,2)*X(2,1)*X(4,3)-X(1,2)*X(2,3)*X(4,1) ...
%     -X(1,3)*X(2,1)*X(4,2)+X(1,3)*X(2,2)*X(4,1)+X(1,1)*X(2,2)*X(5,3)-X(1,1)*X(2,3)*X(5,2)-X(1,1)*X(3,2)*X(4,3) ...
%     +X(1,1)*X(3,3)*X(4,2)-X(1,2)*X(2,1)*X(5,3)+X(1,2)*X(2,3)*X(5,1)+X(1,2)*X(3,1)*X(4,3)-X(1,2)*X(3,3)*X(4,1) ...
%     +X(1,3)*X(2,1)*X(5,2)-X(1,3)*X(2,2)*X(5,1)-X(1,3)*X(3,1)*X(4,2)+X(1,3)*X(3,2)*X(4,1)+X(1,1)*X(2,2)*X(6,3) ...
%     -X(1,1)*X(2,3)*X(6,2)-X(1,2)*X(2,1)*X(6,3)+X(1,2)*X(2,3)*X(6,1)+X(1,3)*X(2,1)*X(6,2)-X(1,3)*X(2,2)*X(6,1) ...
%     -X(2,1)*X(3,2)*X(4,3)+X(2,1)*X(3,3)*X(4,2)+X(2,2)*X(3,1)*X(4,3)-X(2,2)*X(3,3)*X(4,1)-X(2,3)*X(3,1)*X(4,2) ...
%     +X(2,3)*X(3,2)*X(4,1)-X(1,1)*X(4,2)*X(5,3)+X(1,1)*X(4,3)*X(5,2)+X(1,2)*X(4,1)*X(5,3)-X(1,2)*X(4,3)*X(5,1) ...
%     -X(1,3)*X(4,1)*X(5,2)+X(1,3)*X(4,2)*X(5,1)+X(2,1)*X(3,2)*X(6,3)-X(2,1)*X(3,3)*X(6,2)-X(2,2)*X(3,1)*X(6,3) ...
%     +X(2,2)*X(3,3)*X(6,1)+X(2,3)*X(3,1)*X(6,2)-X(2,3)*X(3,2)*X(6,1)-X(1,1)*X(5,2)*X(6,3)+X(1,1)*X(5,3)*X(6,2) ...
%     +X(1,2)*X(5,1)*X(6,3)-X(1,2)*X(5,3)*X(6,1)-X(1,3)*X(5,1)*X(6,2)+X(1,3)*X(5,2)*X(6,1)+X(2,1)*X(3,2)*X(7,3) ...
%     -X(2,1)*X(3,3)*X(7,2)-X(2,2)*X(3,1)*X(7,3)+X(2,2)*X(3,3)*X(7,1)+X(2,3)*X(3,1)*X(7,2)-X(2,3)*X(3,2)*X(7,1) ...
%     -X(1,1)*X(4,2)*X(8,3)+X(1,1)*X(4,3)*X(8,2)+X(1,2)*X(4,1)*X(8,3)-X(1,2)*X(4,3)*X(8,1)-X(1,3)*X(4,1)*X(8,2) ...
%     +X(1,3)*X(4,2)*X(8,1)-X(2,1)*X(5,2)*X(6,3)+X(2,1)*X(5,3)*X(6,2)+X(2,2)*X(5,1)*X(6,3)-X(2,2)*X(5,3)*X(6,1) ...
%     -X(2,3)*X(5,1)*X(6,2)+X(2,3)*X(5,2)*X(6,1)+X(1,1)*X(5,2)*X(8,3)-X(1,1)*X(5,3)*X(8,2)-X(1,2)*X(5,1)*X(8,3) ...
%     +X(1,2)*X(5,3)*X(8,1)+X(1,3)*X(5,1)*X(8,2)-X(1,3)*X(5,2)*X(8,1)+X(3,1)*X(4,2)*X(7,3)-X(3,1)*X(4,3)*X(7,2) ...
%     -X(3,2)*X(4,1)*X(7,3)+X(3,2)*X(4,3)*X(7,1)+X(3,3)*X(4,1)*X(7,2)-X(3,3)*X(4,2)*X(7,1)-X(2,1)*X(6,2)*X(7,3) ...
%     +X(2,1)*X(6,3)*X(7,2)+X(2,2)*X(6,1)*X(7,3)-X(2,2)*X(6,3)*X(7,1)-X(2,3)*X(6,1)*X(7,2)+X(2,3)*X(6,2)*X(7,1) ...
%     +X(3,1)*X(4,2)*X(8,3)-X(3,1)*X(4,3)*X(8,2)-X(3,2)*X(4,1)*X(8,3)+X(3,2)*X(4,3)*X(8,1)+X(3,3)*X(4,1)*X(8,2) ...
%     -X(3,3)*X(4,2)*X(8,1)-X(3,1)*X(6,2)*X(7,3)+X(3,1)*X(6,3)*X(7,2)+X(3,2)*X(6,1)*X(7,3)-X(3,2)*X(6,3)*X(7,1) ...
%     -X(3,3)*X(6,1)*X(7,2)+X(3,3)*X(6,2)*X(7,1)+X(4,1)*X(5,2)*X(8,3)-X(4,1)*X(5,3)*X(8,2)-X(4,2)*X(5,1)*X(8,3) ...
%     +X(4,2)*X(5,3)*X(8,1)+X(4,3)*X(5,1)*X(8,2)-X(4,3)*X(5,2)*X(8,1)-X(3,1)*X(7,2)*X(8,3)+X(3,1)*X(7,3)*X(8,2) ...
%     +X(3,2)*X(7,1)*X(8,3)-X(3,2)*X(7,3)*X(8,1)-X(3,3)*X(7,1)*X(8,2)+X(3,3)*X(7,2)*X(8,1)+X(5,1)*X(6,2)*X(7,3) ...
%     -X(5,1)*X(6,3)*X(7,2)-X(5,2)*X(6,1)*X(7,3)+X(5,2)*X(6,3)*X(7,1)+X(5,3)*X(6,1)*X(7,2)-X(5,3)*X(6,2)*X(7,1) ...
%     -X(4,1)*X(7,2)*X(8,3)+X(4,1)*X(7,3)*X(8,2)+X(4,2)*X(7,1)*X(8,3)-X(4,2)*X(7,3)*X(8,1)-X(4,3)*X(7,1)*X(8,2) ...
%     +X(4,3)*X(7,2)*X(8,1)+X(5,1)*X(6,2)*X(8,3)-X(5,1)*X(6,3)*X(8,2)-X(5,2)*X(6,1)*X(8,3)+X(5,2)*X(6,3)*X(8,1) ...
%     +X(5,3)*X(6,1)*X(8,2)-X(5,3)*X(6,2)*X(8,1)+X(5,1)*X(7,2)*X(8,3)-X(5,1)*X(7,3)*X(8,2)-X(5,2)*X(7,1)*X(8,3) ...
%     +X(5,2)*X(7,3)*X(8,1)+X(5,3)*X(7,1)*X(8,2)-X(5,3)*X(7,2)*X(8,1)+X(6,1)*X(7,2)*X(8,3)-X(6,1)*X(7,3)*X(8,2) ...
%     -X(6,2)*X(7,1)*X(8,3)+X(6,2)*X(7,3)*X(8,1)+X(6,3)*X(7,1)*X(8,2)-X(6,3)*X(7,2)*X(8,1);
% V=V/12;
% end
%
% function K = stiffness (self, assembler, geom, u1, varargin)
% % Compute the stiffness matrix by computing and assembling the
% % matrices of the individual FEs.
% %
% % function K = stiffness (self, assembler, geom, u1, u)
% %
% % Return a stiffness matrix.
% %     assembler = descendent of the sysmat_assembler class
% %     geom=geometry field
% %     u1=displacement field, the current configuration
% %     u=displacement field, the last known configuration
%
% if isempty(self.phis)%  Do we need to calculate the form factors?
%     self=self.update(geom, u1, u1);
% end
%
% % Integration rule
% [npts, Ns, gradNparams, w] = integration_data (self);;
% gradN =cell(8,1); Jac=cell(8,1);
% % Material orientation
% Rm_constant = is_material_orientation_constant(self);% if not constant, need to compute  at each point
% if (~Rm_constant)
%     Rmh = self.Rm;% handle to a function  to evaluate Rm
% else
%     Rm = self.Rm;
%     if (isempty(Rm)),Rm=eye(3);end % for identity transformation
% end
% % Retrieve data for efficiency
% conns = self.fes.conn; % connectivity
% labels = self.fes.label; % connectivity
% Xs = geom.values; % reference coordinates
% context.F = [];
% context.stiff_type='Eulerian';
% % Prepare assembler
% Kedim =u1.dim*self.fes.nfens;
% start_assembly(assembler, Kedim, Kedim, size(conns,1), u1.nfreedofs, u1.nfreedofs);
% tic;
% for i=1:size(conns,1)
%     conn =conns(i,:); % connectivity
%     X=Xs(conn,:);
%     % First we calculate  the mean basis function gradient matrix and the volume of the element
%     gradN_mean =zeros(self.fes.nfens,u1.dim); V=0;
%     for j=1:npts % loop over all quadrature points
%         J = X' * gradNparams{j};% Jacobian matrix wrt reference coordinates
%         gradN{j} = gradNparams{j}/J;% derivatives wrt global reference coor
%         Jac{j} = det(J);       % if (Jac{j}<=0),error('Non-positive Jacobian');end
%         dV=(Jac{j}*w(j));
%         gradN_mean =gradN_mean+gradN{j}*dV;
%         V =V+dV;
%     end
%     gradN_mean=gradN_mean/V; % Finish the calculation of the mean basis function gradient matrix
%     %     V2 =V_analytically(X);
%     %     gradN_mean2=gradN_mean_analytical(X,V);
% end
% toc
% % tic;
% % for i=1:size(conns,1)
% %     conn =conns(i,:); % connectivity
% %     X=Xs(conn,:);
% %     % First we calculate  the mean basis function gradient matrix and the volume of the element
% %     %     gradN_mean =zeros(self.fes.nfens,u1.dim); V=0;
% %     %     for j=1:npts % loop over all quadrature points
% %     %         J = X' * gradNparams{j};% Jacobian matrix wrt reference coordinates
% %     %         gradN{j} = gradNparams{j}/J;% derivatives wrt global reference coor
% %     %         Jac{j} = det(J);       % if (Jac{j}<=0),error('Non-positive Jacobian');end
% %     %         dV=(Jac{j}*w(j));
% %     %         gradN_mean =gradN_mean+gradN{j}*dV;
% %     %         V =V+dV;
% %     %     end
% %     %     gradN_mean=gradN_mean/V; % Finish the calculation of the mean basis function gradient matrix
% %         V =V_analytically(X);
% %         gradN_mean=gradN_mean_analytical(X,V);
% % end
% % toc
% tic;
% for i=1:size(conns,1)
%     conn =conns(i,:); % connectivity
%     X=Xs(conn,:);
%     % First we calculate  the mean basis function gradient matrix and the volume of the element
%     gradN_mean =zeros(self.fes.nfens,u1.dim); V=0;
%     for j=1:npts % loop over all quadrature points
%         J = X' * gradNparams{j};% Jacobian matrix wrt reference coordinates
%         gradN{j} = gradNparams{j}*adjugate3(J);% derivatives wrt global reference coor
%         Jac{j} = det(J);       % if (Jac{j}<=0),error('Non-positive Jacobian');end
%         gradN_mean =gradN_mean+gradN{j}*w(j);
%         V =V+Jac{j}*w(j);
%     end
%     gradN_mean=gradN_mean/V; % Finish the calculation of the mean basis function gradient matrix
%     %         V =V_analytically(X);
%     %         gradN_mean=gradN_mean_analytical(X,V);
% end
% toc
% tic;
% for i=1:size(conns,1)
%     conn =conns(i,:); % connectivity
%     X=Xs(conn,:);
%     % First we calculate  the mean basis function gradient matrix and the volume of the element
%     gradN_mean =zeros(self.fes.nfens,u1.dim); V=0; adjJ=zeros(3);
%     for j=1:npts % loop over all quadrature points
%         J = X' * gradNparams{j};% Jacobian matrix wrt reference coordinates
%         adjJ(1,1) =(J(5)*J(9)-J(8)*J(6));
%         adjJ(1,2) =-(J(4)*J(9)-J(7)*J(6));
%         adjJ(1,3) =(J(4)*J(8)-J(7)*J(5));
%
%         adjJ(2,1) =-(J(2)*J(9)-J(8)*J(3));
%         adjJ(2,2) =(J(1)*J(9)-J(7)*J(3));
%         adjJ(2,3) =-(J(1)*J(8)-J(7)*J(2));
%
%         adjJ(3,1) =(J(2)*J(6)-J(5)*J(3));
%         adjJ(3,2) =-(J(1)*J(6)-J(4)*J(3));
%         adjJ(3,3) =(J(1)*J(5)-J(4)*J(2));
%         gradN{j} = gradNparams{j}*adjJ;% derivatives wrt global reference coor
%         Jac{j} = det(J);       % if (Jac{j}<=0),error('Non-positive Jacobian');end
%         gradN_mean =gradN_mean+gradN{j}*w(j);
%         V =V+Jac{j}*w(j);
%     end
%     gradN_mean=gradN_mean/V; % Finish the calculation of the mean basis function gradient matrix
%     %         V =V_analytically(X);
%     %         gradN_mean=gradN_mean_analytical(X,V);
% end
% toc
% K = make_matrix (assembler);
% end



function gradN =gradients(X,Jac)
gradN{1}=1/(8*Jac{1})*[
(X(5,3) - X(4,3))*X(2,2) + (X(2,3)*X(4,2) - X(2,3)*X(5,2) - X(4,2)*X(5,3) + X(4,3)*X(5,2)),    (X(4,3) - X(5,3))*X(2,1) + (X(2,3)*X(5,1) - X(2,3)*X(4,1) + X(4,1)*X(5,3) - X(4,3)*X(5,1)),    (X(5,2) - X(4,2))*X(2,1) + (X(2,2)*X(4,1) - X(2,2)*X(5,1) - X(4,1)*X(5,2) + X(4,2)*X(5,1)),    
(X(4,3) - X(5,3))*X(1,2) + (X(1,3)*X(5,2) - X(1,3)*X(4,2) + X(4,2)*X(5,3) - X(4,3)*X(5,2)),    (X(5,3) - X(4,3))*X(1,1) + (X(1,3)*X(4,1) - X(1,3)*X(5,1) - X(4,1)*X(5,3) + X(4,3)*X(5,1)),    (X(4,2) - X(5,2))*X(1,1) + (X(1,2)*X(5,1) - X(1,2)*X(4,1) + X(4,1)*X(5,2) - X(4,2)*X(5,1)),    
0,    0,    0,    
(X(5,3) - X(2,3))*X(1,2) + (X(1,3)*X(2,2) - X(1,3)*X(5,2) - X(2,2)*X(5,3) + X(2,3)*X(5,2)),    (X(2,3) - X(5,3))*X(1,1) + (X(1,3)*X(5,1) - X(1,3)*X(2,1) + X(2,1)*X(5,3) - X(2,3)*X(5,1)),    (X(5,2) - X(2,2))*X(1,1) + (X(1,2)*X(2,1) - X(1,2)*X(5,1) - X(2,1)*X(5,2) + X(2,2)*X(5,1)),    
(X(2,3) - X(4,3))*X(1,2) + (X(1,3)*X(4,2) - X(1,3)*X(2,2) + X(2,2)*X(4,3) - X(2,3)*X(4,2)),    (X(4,3) - X(2,3))*X(1,1) + (X(1,3)*X(2,1) - X(1,3)*X(4,1) - X(2,1)*X(4,3) + X(2,3)*X(4,1)),    (X(2,2) - X(4,2))*X(1,1) + (X(1,2)*X(4,1) - X(1,2)*X(2,1) + X(2,1)*X(4,2) - X(2,2)*X(4,1)),    
0,    0,    0,    
0,    0,    0,    
0,    0,    0,    
];
gradN{2}=1/(8*Jac{2})*[
(X(6,3) - X(3,3))*X(2,2) + (X(2,3)*X(3,2) - X(2,3)*X(6,2) - X(3,2)*X(6,3) + X(3,3)*X(6,2)),    (X(3,3) - X(6,3))*X(2,1) + (X(2,3)*X(6,1) - X(2,3)*X(3,1) + X(3,1)*X(6,3) - X(3,3)*X(6,1)),    (X(6,2) - X(3,2))*X(2,1) + (X(2,2)*X(3,1) - X(2,2)*X(6,1) - X(3,1)*X(6,2) + X(3,2)*X(6,1)),    
(X(3,3) - X(6,3))*X(1,2) + (X(1,3)*X(6,2) - X(1,3)*X(3,2) + X(3,2)*X(6,3) - X(3,3)*X(6,2)),    (X(6,3) - X(3,3))*X(1,1) + (X(1,3)*X(3,1) - X(1,3)*X(6,1) - X(3,1)*X(6,3) + X(3,3)*X(6,1)),    (X(3,2) - X(6,2))*X(1,1) + (X(1,2)*X(6,1) - X(1,2)*X(3,1) + X(3,1)*X(6,2) - X(3,2)*X(6,1)),    
(X(6,3) - X(2,3))*X(1,2) + (X(1,3)*X(2,2) - X(1,3)*X(6,2) - X(2,2)*X(6,3) + X(2,3)*X(6,2)),    (X(2,3) - X(6,3))*X(1,1) + (X(1,3)*X(6,1) - X(1,3)*X(2,1) + X(2,1)*X(6,3) - X(2,3)*X(6,1)),    (X(6,2) - X(2,2))*X(1,1) + (X(1,2)*X(2,1) - X(1,2)*X(6,1) - X(2,1)*X(6,2) + X(2,2)*X(6,1)),    
0,    0,    0,    
0,    0,    0,    
(X(2,3) - X(3,3))*X(1,2) + (X(1,3)*X(3,2) - X(1,3)*X(2,2) + X(2,2)*X(3,3) - X(2,3)*X(3,2)),    (X(3,3) - X(2,3))*X(1,1) + (X(1,3)*X(2,1) - X(1,3)*X(3,1) - X(2,1)*X(3,3) + X(2,3)*X(3,1)),    (X(2,2) - X(3,2))*X(1,1) + (X(1,2)*X(3,1) - X(1,2)*X(2,1) + X(2,1)*X(3,2) - X(2,2)*X(3,1)),    
0,    0,    0,    
0,    0,    0,    
];
gradN{3}=1/(8*Jac{3})*[
0,    0,    0,    
(X(7,3) - X(4,3))*X(3,2) + (X(3,3)*X(4,2) - X(3,3)*X(7,2) - X(4,2)*X(7,3) + X(4,3)*X(7,2)),    (X(4,3) - X(7,3))*X(3,1) + (X(3,3)*X(7,1) - X(3,3)*X(4,1) + X(4,1)*X(7,3) - X(4,3)*X(7,1)),    (X(7,2) - X(4,2))*X(3,1) + (X(3,2)*X(4,1) - X(3,2)*X(7,1) - X(4,1)*X(7,2) + X(4,2)*X(7,1)),    
(X(4,3) - X(7,3))*X(2,2) + (X(2,3)*X(7,2) - X(2,3)*X(4,2) + X(4,2)*X(7,3) - X(4,3)*X(7,2)),    (X(7,3) - X(4,3))*X(2,1) + (X(2,3)*X(4,1) - X(2,3)*X(7,1) - X(4,1)*X(7,3) + X(4,3)*X(7,1)),    (X(4,2) - X(7,2))*X(2,1) + (X(2,2)*X(7,1) - X(2,2)*X(4,1) + X(4,1)*X(7,2) - X(4,2)*X(7,1)),    
(X(7,3) - X(3,3))*X(2,2) + (X(2,3)*X(3,2) - X(2,3)*X(7,2) - X(3,2)*X(7,3) + X(3,3)*X(7,2)),    (X(3,3) - X(7,3))*X(2,1) + (X(2,3)*X(7,1) - X(2,3)*X(3,1) + X(3,1)*X(7,3) - X(3,3)*X(7,1)),    (X(7,2) - X(3,2))*X(2,1) + (X(2,2)*X(3,1) - X(2,2)*X(7,1) - X(3,1)*X(7,2) + X(3,2)*X(7,1)),    
0,    0,    0,    
0,    0,    0,    
(X(3,3) - X(4,3))*X(2,2) + (X(2,3)*X(4,2) - X(2,3)*X(3,2) + X(3,2)*X(4,3) - X(3,3)*X(4,2)),    (X(4,3) - X(3,3))*X(2,1) + (X(2,3)*X(3,1) - X(2,3)*X(4,1) - X(3,1)*X(4,3) + X(3,3)*X(4,1)),    (X(3,2) - X(4,2))*X(2,1) + (X(2,2)*X(4,1) - X(2,2)*X(3,1) + X(3,1)*X(4,2) - X(3,2)*X(4,1)),    
0,    0,    0,    
];
gradN{4}=1/(8*Jac{4})*[
(X(8,3) - X(4,3))*X(3,2) + (X(3,3)*X(4,2) - X(3,3)*X(8,2) - X(4,2)*X(8,3) + X(4,3)*X(8,2)),    (X(4,3) - X(8,3))*X(3,1) + (X(3,3)*X(8,1) - X(3,3)*X(4,1) + X(4,1)*X(8,3) - X(4,3)*X(8,1)),    (X(8,2) - X(4,2))*X(3,1) + (X(3,2)*X(4,1) - X(3,2)*X(8,1) - X(4,1)*X(8,2) + X(4,2)*X(8,1)),    
0,    0,    0,    
(X(4,3) - X(8,3))*X(1,2) + (X(1,3)*X(8,2) - X(1,3)*X(4,2) + X(4,2)*X(8,3) - X(4,3)*X(8,2)),    (X(8,3) - X(4,3))*X(1,1) + (X(1,3)*X(4,1) - X(1,3)*X(8,1) - X(4,1)*X(8,3) + X(4,3)*X(8,1)),    (X(4,2) - X(8,2))*X(1,1) + (X(1,2)*X(8,1) - X(1,2)*X(4,1) + X(4,1)*X(8,2) - X(4,2)*X(8,1)),    
(X(8,3) - X(3,3))*X(1,2) + (X(1,3)*X(3,2) - X(1,3)*X(8,2) - X(3,2)*X(8,3) + X(3,3)*X(8,2)),    (X(3,3) - X(8,3))*X(1,1) + (X(1,3)*X(8,1) - X(1,3)*X(3,1) + X(3,1)*X(8,3) - X(3,3)*X(8,1)),    (X(8,2) - X(3,2))*X(1,1) + (X(1,2)*X(3,1) - X(1,2)*X(8,1) - X(3,1)*X(8,2) + X(3,2)*X(8,1)),    
0,    0,    0,    
0,    0,    0,    
0,    0,    0,    
(X(3,3) - X(4,3))*X(1,2) + (X(1,3)*X(4,2) - X(1,3)*X(3,2) + X(3,2)*X(4,3) - X(3,3)*X(4,2)),    (X(4,3) - X(3,3))*X(1,1) + (X(1,3)*X(3,1) - X(1,3)*X(4,1) - X(3,1)*X(4,3) + X(3,3)*X(4,1)),    (X(3,2) - X(4,2))*X(1,1) + (X(1,2)*X(4,1) - X(1,2)*X(3,1) + X(3,1)*X(4,2) - X(3,2)*X(4,1)),    
];
gradN{5}=1/(8*Jac{5})*[
(X(8,3) - X(6,3))*X(5,2) + (X(5,3)*X(6,2) - X(5,3)*X(8,2) - X(6,2)*X(8,3) + X(6,3)*X(8,2)),    (X(6,3) - X(8,3))*X(5,1) + (X(5,3)*X(8,1) - X(5,3)*X(6,1) + X(6,1)*X(8,3) - X(6,3)*X(8,1)),    (X(8,2) - X(6,2))*X(5,1) + (X(5,2)*X(6,1) - X(5,2)*X(8,1) - X(6,1)*X(8,2) + X(6,2)*X(8,1)),    
0,    0,    0,    
0,    0,    0,    
0,    0,    0,    
(X(6,3) - X(8,3))*X(1,2) + (X(1,3)*X(8,2) - X(1,3)*X(6,2) + X(6,2)*X(8,3) - X(6,3)*X(8,2)),    (X(8,3) - X(6,3))*X(1,1) + (X(1,3)*X(6,1) - X(1,3)*X(8,1) - X(6,1)*X(8,3) + X(6,3)*X(8,1)),    (X(6,2) - X(8,2))*X(1,1) + (X(1,2)*X(8,1) - X(1,2)*X(6,1) + X(6,1)*X(8,2) - X(6,2)*X(8,1)),    
(X(8,3) - X(5,3))*X(1,2) + (X(1,3)*X(5,2) - X(1,3)*X(8,2) - X(5,2)*X(8,3) + X(5,3)*X(8,2)),    (X(5,3) - X(8,3))*X(1,1) + (X(1,3)*X(8,1) - X(1,3)*X(5,1) + X(5,1)*X(8,3) - X(5,3)*X(8,1)),    (X(8,2) - X(5,2))*X(1,1) + (X(1,2)*X(5,1) - X(1,2)*X(8,1) - X(5,1)*X(8,2) + X(5,2)*X(8,1)),    
0,    0,    0,    
(X(5,3) - X(6,3))*X(1,2) + (X(1,3)*X(6,2) - X(1,3)*X(5,2) + X(5,2)*X(6,3) - X(5,3)*X(6,2)),    (X(6,3) - X(5,3))*X(1,1) + (X(1,3)*X(5,1) - X(1,3)*X(6,1) - X(5,1)*X(6,3) + X(5,3)*X(6,1)),    (X(5,2) - X(6,2))*X(1,1) + (X(1,2)*X(6,1) - X(1,2)*X(5,1) + X(5,1)*X(6,2) - X(5,2)*X(6,1)),    
];
gradN{6}=1/(8*Jac{6})*[
0,    0,    0,    
(X(7,3) - X(6,3))*X(5,2) + (X(5,3)*X(6,2) - X(5,3)*X(7,2) - X(6,2)*X(7,3) + X(6,3)*X(7,2)),    (X(6,3) - X(7,3))*X(5,1) + (X(5,3)*X(7,1) - X(5,3)*X(6,1) + X(6,1)*X(7,3) - X(6,3)*X(7,1)),    (X(7,2) - X(6,2))*X(5,1) + (X(5,2)*X(6,1) - X(5,2)*X(7,1) - X(6,1)*X(7,2) + X(6,2)*X(7,1)),    
0,    0,    0,    
0,    0,    0,    
(X(6,3) - X(7,3))*X(2,2) + (X(2,3)*X(7,2) - X(2,3)*X(6,2) + X(6,2)*X(7,3) - X(6,3)*X(7,2)),    (X(7,3) - X(6,3))*X(2,1) + (X(2,3)*X(6,1) - X(2,3)*X(7,1) - X(6,1)*X(7,3) + X(6,3)*X(7,1)),    (X(6,2) - X(7,2))*X(2,1) + (X(2,2)*X(7,1) - X(2,2)*X(6,1) + X(6,1)*X(7,2) - X(6,2)*X(7,1)),    
(X(7,3) - X(5,3))*X(2,2) + (X(2,3)*X(5,2) - X(2,3)*X(7,2) - X(5,2)*X(7,3) + X(5,3)*X(7,2)),    (X(5,3) - X(7,3))*X(2,1) + (X(2,3)*X(7,1) - X(2,3)*X(5,1) + X(5,1)*X(7,3) - X(5,3)*X(7,1)),    (X(7,2) - X(5,2))*X(2,1) + (X(2,2)*X(5,1) - X(2,2)*X(7,1) - X(5,1)*X(7,2) + X(5,2)*X(7,1)),    
(X(5,3) - X(6,3))*X(2,2) + (X(2,3)*X(6,2) - X(2,3)*X(5,2) + X(5,2)*X(6,3) - X(5,3)*X(6,2)),    (X(6,3) - X(5,3))*X(2,1) + (X(2,3)*X(5,1) - X(2,3)*X(6,1) - X(5,1)*X(6,3) + X(5,3)*X(6,1)),    (X(5,2) - X(6,2))*X(2,1) + (X(2,2)*X(6,1) - X(2,2)*X(5,1) + X(5,1)*X(6,2) - X(5,2)*X(6,1)),    
0,    0,    0,    
];
gradN{7}=1/(8*Jac{7})*[
0,    0,    0,    
0,    0,    0,    
(X(8,3) - X(7,3))*X(6,2) + (X(6,3)*X(7,2) - X(6,3)*X(8,2) - X(7,2)*X(8,3) + X(7,3)*X(8,2)),    (X(7,3) - X(8,3))*X(6,1) + (X(6,3)*X(8,1) - X(6,3)*X(7,1) + X(7,1)*X(8,3) - X(7,3)*X(8,1)),    (X(8,2) - X(7,2))*X(6,1) + (X(6,2)*X(7,1) - X(6,2)*X(8,1) - X(7,1)*X(8,2) + X(7,2)*X(8,1)),    
0,    0,    0,    
0,    0,    0,    
(X(7,3) - X(8,3))*X(3,2) + (X(3,3)*X(8,2) - X(3,3)*X(7,2) + X(7,2)*X(8,3) - X(7,3)*X(8,2)),    (X(8,3) - X(7,3))*X(3,1) + (X(3,3)*X(7,1) - X(3,3)*X(8,1) - X(7,1)*X(8,3) + X(7,3)*X(8,1)),    (X(7,2) - X(8,2))*X(3,1) + (X(3,2)*X(8,1) - X(3,2)*X(7,1) + X(7,1)*X(8,2) - X(7,2)*X(8,1)),    
(X(8,3) - X(6,3))*X(3,2) + (X(3,3)*X(6,2) - X(3,3)*X(8,2) - X(6,2)*X(8,3) + X(6,3)*X(8,2)),    (X(6,3) - X(8,3))*X(3,1) + (X(3,3)*X(8,1) - X(3,3)*X(6,1) + X(6,1)*X(8,3) - X(6,3)*X(8,1)),    (X(8,2) - X(6,2))*X(3,1) + (X(3,2)*X(6,1) - X(3,2)*X(8,1) - X(6,1)*X(8,2) + X(6,2)*X(8,1)),    
(X(6,3) - X(7,3))*X(3,2) + (X(3,3)*X(7,2) - X(3,3)*X(6,2) + X(6,2)*X(7,3) - X(6,3)*X(7,2)),    (X(7,3) - X(6,3))*X(3,1) + (X(3,3)*X(6,1) - X(3,3)*X(7,1) - X(6,1)*X(7,3) + X(6,3)*X(7,1)),    (X(6,2) - X(7,2))*X(3,1) + (X(3,2)*X(7,1) - X(3,2)*X(6,1) + X(6,1)*X(7,2) - X(6,2)*X(7,1)),    
];
gradN{8}=1/(8*Jac{8})*[
0,    0,    0,    
0,    0,    0,    
0,    0,    0,    
(X(8,3) - X(7,3))*X(5,2) + (X(5,3)*X(7,2) - X(5,3)*X(8,2) - X(7,2)*X(8,3) + X(7,3)*X(8,2)),    (X(7,3) - X(8,3))*X(5,1) + (X(5,3)*X(8,1) - X(5,3)*X(7,1) + X(7,1)*X(8,3) - X(7,3)*X(8,1)),    (X(8,2) - X(7,2))*X(5,1) + (X(5,2)*X(7,1) - X(5,2)*X(8,1) - X(7,1)*X(8,2) + X(7,2)*X(8,1)),    
(X(7,3) - X(8,3))*X(4,2) + (X(4,3)*X(8,2) - X(4,3)*X(7,2) + X(7,2)*X(8,3) - X(7,3)*X(8,2)),    (X(8,3) - X(7,3))*X(4,1) + (X(4,3)*X(7,1) - X(4,3)*X(8,1) - X(7,1)*X(8,3) + X(7,3)*X(8,1)),    (X(7,2) - X(8,2))*X(4,1) + (X(4,2)*X(8,1) - X(4,2)*X(7,1) + X(7,1)*X(8,2) - X(7,2)*X(8,1)),    
0,    0,    0,    
(X(8,3) - X(5,3))*X(4,2) + (X(4,3)*X(5,2) - X(4,3)*X(8,2) - X(5,2)*X(8,3) + X(5,3)*X(8,2)),    (X(5,3) - X(8,3))*X(4,1) + (X(4,3)*X(8,1) - X(4,3)*X(5,1) + X(5,1)*X(8,3) - X(5,3)*X(8,1)),    (X(8,2) - X(5,2))*X(4,1) + (X(4,2)*X(5,1) - X(4,2)*X(8,1) - X(5,1)*X(8,2) + X(5,2)*X(8,1)),    
(X(5,3) - X(7,3))*X(4,2) + (X(4,3)*X(7,2) - X(4,3)*X(5,2) + X(5,2)*X(7,3) - X(5,3)*X(7,2)),    (X(7,3) - X(5,3))*X(4,1) + (X(4,3)*X(5,1) - X(4,3)*X(7,1) - X(5,1)*X(7,3) + X(5,3)*X(7,1)),    (X(5,2) - X(7,2))*X(4,1) + (X(4,2)*X(7,1) - X(4,2)*X(5,1) + X(5,1)*X(7,2) - X(5,2)*X(7,1)),    
];
end

function Jac= jacobians(X)
Jac{1}=(1/8)*( (X(2,3)*X(4,2) - X(2,2)*X(4,3) + X(2,2)*X(5,3) - X(2,3)*X(5,2) - X(4,2)*X(5,3) + X(4,3)*X(5,2))*X(1,1) + (X(1,2)*X(2,1)*X(4,3) - X(1,2)*X(2,3)*X(4,1) - X(1,3)*X(2,1)*X(4,2) + X(1,3)*X(2,2)*X(4,1) - X(1,2)*X(2,1)*X(5,3) + X(1,2)*X(2,3)*X(5,1) + X(1,3)*X(2,1)*X(5,2) - X(1,3)*X(2,2)*X(5,1) + X(1,2)*X(4,1)*X(5,3) - X(1,2)*X(4,3)*X(5,1) - X(1,3)*X(4,1)*X(5,2) + X(1,3)*X(4,2)*X(5,1) + X(2,1)*X(4,2)*X(5,3) - X(2,1)*X(4,3)*X(5,2) - X(2,2)*X(4,1)*X(5,3) + X(2,2)*X(4,3)*X(5,1) + X(2,3)*X(4,1)*X(5,2) - X(2,3)*X(4,2)*X(5,1)) );
Jac{2}=(1/8)*( (X(2,3)*X(3,2) - X(2,2)*X(3,3) + X(2,2)*X(6,3) - X(2,3)*X(6,2) - X(3,2)*X(6,3) + X(3,3)*X(6,2))*X(1,1) + (X(1,2)*X(2,1)*X(3,3) - X(1,2)*X(2,3)*X(3,1) - X(1,3)*X(2,1)*X(3,2) + X(1,3)*X(2,2)*X(3,1) - X(1,2)*X(2,1)*X(6,3) + X(1,2)*X(2,3)*X(6,1) + X(1,3)*X(2,1)*X(6,2) - X(1,3)*X(2,2)*X(6,1) + X(1,2)*X(3,1)*X(6,3) - X(1,2)*X(3,3)*X(6,1) - X(1,3)*X(3,1)*X(6,2) + X(1,3)*X(3,2)*X(6,1) + X(2,1)*X(3,2)*X(6,3) - X(2,1)*X(3,3)*X(6,2) - X(2,2)*X(3,1)*X(6,3) + X(2,2)*X(3,3)*X(6,1) + X(2,3)*X(3,1)*X(6,2) - X(2,3)*X(3,2)*X(6,1)) );
Jac{3}=(1/8)*( (X(3,3)*X(4,2) - X(3,2)*X(4,3) + X(3,2)*X(7,3) - X(3,3)*X(7,2) - X(4,2)*X(7,3) + X(4,3)*X(7,2))*X(2,1) + (X(2,2)*X(3,1)*X(4,3) - X(2,2)*X(3,3)*X(4,1) - X(2,3)*X(3,1)*X(4,2) + X(2,3)*X(3,2)*X(4,1) - X(2,2)*X(3,1)*X(7,3) + X(2,2)*X(3,3)*X(7,1) + X(2,3)*X(3,1)*X(7,2) - X(2,3)*X(3,2)*X(7,1) + X(2,2)*X(4,1)*X(7,3) - X(2,2)*X(4,3)*X(7,1) - X(2,3)*X(4,1)*X(7,2) + X(2,3)*X(4,2)*X(7,1) + X(3,1)*X(4,2)*X(7,3) - X(3,1)*X(4,3)*X(7,2) - X(3,2)*X(4,1)*X(7,3) + X(3,2)*X(4,3)*X(7,1) + X(3,3)*X(4,1)*X(7,2) - X(3,3)*X(4,2)*X(7,1)) );
Jac{4}=(1/8)*( (X(3,3)*X(4,2) - X(3,2)*X(4,3) + X(3,2)*X(8,3) - X(3,3)*X(8,2) - X(4,2)*X(8,3) + X(4,3)*X(8,2))*X(1,1) + (X(1,2)*X(3,1)*X(4,3) - X(1,2)*X(3,3)*X(4,1) - X(1,3)*X(3,1)*X(4,2) + X(1,3)*X(3,2)*X(4,1) - X(1,2)*X(3,1)*X(8,3) + X(1,2)*X(3,3)*X(8,1) + X(1,3)*X(3,1)*X(8,2) - X(1,3)*X(3,2)*X(8,1) + X(1,2)*X(4,1)*X(8,3) - X(1,2)*X(4,3)*X(8,1) - X(1,3)*X(4,1)*X(8,2) + X(1,3)*X(4,2)*X(8,1) + X(3,1)*X(4,2)*X(8,3) - X(3,1)*X(4,3)*X(8,2) - X(3,2)*X(4,1)*X(8,3) + X(3,2)*X(4,3)*X(8,1) + X(3,3)*X(4,1)*X(8,2) - X(3,3)*X(4,2)*X(8,1)) );
Jac{5}=(1/8)*( (X(5,3)*X(6,2) - X(5,2)*X(6,3) + X(5,2)*X(8,3) - X(5,3)*X(8,2) - X(6,2)*X(8,3) + X(6,3)*X(8,2))*X(1,1) + (X(1,2)*X(5,1)*X(6,3) - X(1,2)*X(5,3)*X(6,1) - X(1,3)*X(5,1)*X(6,2) + X(1,3)*X(5,2)*X(6,1) - X(1,2)*X(5,1)*X(8,3) + X(1,2)*X(5,3)*X(8,1) + X(1,3)*X(5,1)*X(8,2) - X(1,3)*X(5,2)*X(8,1) + X(1,2)*X(6,1)*X(8,3) - X(1,2)*X(6,3)*X(8,1) - X(1,3)*X(6,1)*X(8,2) + X(1,3)*X(6,2)*X(8,1) + X(5,1)*X(6,2)*X(8,3) - X(5,1)*X(6,3)*X(8,2) - X(5,2)*X(6,1)*X(8,3) + X(5,2)*X(6,3)*X(8,1) + X(5,3)*X(6,1)*X(8,2) - X(5,3)*X(6,2)*X(8,1)) );
Jac{6}=(1/8)*( (X(5,3)*X(6,2) - X(5,2)*X(6,3) + X(5,2)*X(7,3) - X(5,3)*X(7,2) - X(6,2)*X(7,3) + X(6,3)*X(7,2))*X(2,1) + (X(2,2)*X(5,1)*X(6,3) - X(2,2)*X(5,3)*X(6,1) - X(2,3)*X(5,1)*X(6,2) + X(2,3)*X(5,2)*X(6,1) - X(2,2)*X(5,1)*X(7,3) + X(2,2)*X(5,3)*X(7,1) + X(2,3)*X(5,1)*X(7,2) - X(2,3)*X(5,2)*X(7,1) + X(2,2)*X(6,1)*X(7,3) - X(2,2)*X(6,3)*X(7,1) - X(2,3)*X(6,1)*X(7,2) + X(2,3)*X(6,2)*X(7,1) + X(5,1)*X(6,2)*X(7,3) - X(5,1)*X(6,3)*X(7,2) - X(5,2)*X(6,1)*X(7,3) + X(5,2)*X(6,3)*X(7,1) + X(5,3)*X(6,1)*X(7,2) - X(5,3)*X(6,2)*X(7,1)) );
Jac{7}=(1/8)*( (X(6,3)*X(7,2) - X(6,2)*X(7,3) + X(6,2)*X(8,3) - X(6,3)*X(8,2) - X(7,2)*X(8,3) + X(7,3)*X(8,2))*X(3,1) + (X(3,2)*X(6,1)*X(7,3) - X(3,2)*X(6,3)*X(7,1) - X(3,3)*X(6,1)*X(7,2) + X(3,3)*X(6,2)*X(7,1) - X(3,2)*X(6,1)*X(8,3) + X(3,2)*X(6,3)*X(8,1) + X(3,3)*X(6,1)*X(8,2) - X(3,3)*X(6,2)*X(8,1) + X(3,2)*X(7,1)*X(8,3) - X(3,2)*X(7,3)*X(8,1) - X(3,3)*X(7,1)*X(8,2) + X(3,3)*X(7,2)*X(8,1) + X(6,1)*X(7,2)*X(8,3) - X(6,1)*X(7,3)*X(8,2) - X(6,2)*X(7,1)*X(8,3) + X(6,2)*X(7,3)*X(8,1) + X(6,3)*X(7,1)*X(8,2) - X(6,3)*X(7,2)*X(8,1)) );
Jac{8}=(1/8)*( (X(5,3)*X(7,2) - X(5,2)*X(7,3) + X(5,2)*X(8,3) - X(5,3)*X(8,2) - X(7,2)*X(8,3) + X(7,3)*X(8,2))*X(4,1) + (X(4,2)*X(5,1)*X(7,3) - X(4,2)*X(5,3)*X(7,1) - X(4,3)*X(5,1)*X(7,2) + X(4,3)*X(5,2)*X(7,1) - X(4,2)*X(5,1)*X(8,3) + X(4,2)*X(5,3)*X(8,1) + X(4,3)*X(5,1)*X(8,2) - X(4,3)*X(5,2)*X(8,1) + X(4,2)*X(7,1)*X(8,3) - X(4,2)*X(7,3)*X(8,1) - X(4,3)*X(7,1)*X(8,2) + X(4,3)*X(7,2)*X(8,1) + X(5,1)*X(7,2)*X(8,3) - X(5,1)*X(7,3)*X(8,2) - X(5,2)*X(7,1)*X(8,3) + X(5,2)*X(7,3)*X(8,1) + X(5,3)*X(7,1)*X(8,2) - X(5,3)*X(7,2)*X(8,1)) );
end

function gradN_mean =mean_gradient(gradN,Jac)
gradN_mean=zeros(size(gradN{1})); sumJac=0;
for  j =1:length(gradN)
    gradN_mean=gradN_mean+Jac{j}*gradN{j};
    sumJac=sumJac+Jac{j};
end
gradN_mean = gradN_mean/sumJac;
end

%     Jac= jacobians(X);
    %     gradN =gradients(X,Jac);
    %     gradN_mean =mean_gradient(gradN,Jac);
    